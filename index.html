<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hangman: Harvest Town Edition ‚Äì Fixed</title>
  <style>
    :root {
      --bg: #0f172a;
      --surface: #111827;
      --muted: #1f2937;
      --text: #e5e7eb;
      --accent: #60a5fa;
      --good: #34d399;
      --bad: #f87171;
      --warn: #fbbf24;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    
    /* Container for proper mobile spacing */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px;
    }
    
    /* Banner Styles */
    .banner {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, #2563eb 0%, #059669 25%, #d97706 50%, #dc2626 75%, #7c3aed 100%);
      background-size: 400% 400%;
      animation: gradientShift 8s ease infinite;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
    }
    
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 200" fill="none"><path d="M0 100c50-20 100-40 150-20s100 40 150 20s100-40 150-20v100H0z" fill="rgba(255,255,255,0.1)"/><path d="M0 120c50-15 100-30 150-15s100 30 150 15s100-30 150-15v80H0z" fill="rgba(255,255,255,0.05)"/></svg>') no-repeat center;
      background-size: cover;
      animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    .banner-content {
      text-align: center;
      z-index: 2;
      position: relative;
    }
    
    .banner-title {
      font-size: 3.5rem;
      font-weight: 900;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 20px rgba(255,255,255,0.3);
      margin: 0 0 8px 0;
      letter-spacing: -0.02em;
    }
    
    .banner-subtitle {
      font-size: 1.2rem;
      color: rgba(255,255,255,0.9);
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
      margin: 0;
    }
    
    .banner-icons {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 2rem;
      animation: bounce 3s infinite;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }
    
    @media (max-width: 768px) {
      .banner {
        height: 150px;
      }
      .banner-title {
        font-size: 2.5rem;
      }
      .banner-subtitle {
        font-size: 1rem;
      }
      .banner-icons {
        font-size: 1.5rem;
        right: 20px;
        top: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .banner {
        height: 120px;
      }
      .banner-title {
        font-size: 2rem;
      }
      .banner-subtitle {
        font-size: 0.9rem;
      }
    }
    .card { background: var(--surface); border: 1px solid #1f2937; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    h1,h2,h3{ margin:0 0 12px }
    .grid { display:grid; gap:16px }
    .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .btn{ appearance:none; background:var(--muted); color:var(--text); border:1px solid #374151; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600 }
    .btn:hover{ background:#374151 }
    .btn-primary{ background:var(--accent); color:#071126 }
    .btn-good{ background:var(--good); color:#052e1e }
    .btn-online{ background:linear-gradient(45deg, #059669, #2563eb); color:white; }
    .btn-online:hover{ background:linear-gradient(45deg, #047857, #1d4ed8); }
    .input, textarea { width:100%; background:#0b1220; color:var(--text); border:1px solid #334155; border-radius:12px; padding:10px 12px }
    .kbd{ display:inline-flex; align-items:center; justify-content:center; min-width:32px; padding:6px 8px; border-radius:10px; border:1px solid #334155; background:#0b1220; font-weight:700; margin:4px; cursor:pointer; color:#ffffff }
    .kbd:hover:not([disabled]){ color:var(--accent); transform:translateY(-2px) }
    .kbd[disabled]{ opacity:.45; cursor:not-allowed; color:#ffffff }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    .pill{ padding:6px 10px; border-radius:999px; border:1px solid #374151; background:#0b1220; font-weight:700 }
    .hidden{ display:none !important }
    
    /* Improved word display with mobile responsiveness */
    .word{ 
      font-family: 'Courier New', monospace;
      font-weight: 800; 
      text-align: center; 
      padding: 16px 12px; 
      border-radius: 12px; 
      background: #0b1220; 
      border: 1px dashed #334155; 
      line-height: 1.4;
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: none;
      /* Responsive font sizing */
      font-size: clamp(1.5rem, 4vw, 2.25rem);
      /* Responsive letter spacing */
      letter-spacing: clamp(0.1em, 0.5vw, 0.3em);
      /* Allow text to wrap to multiple lines */
      white-space: pre-wrap;
      /* Ensure it doesn't overflow horizontally */
      max-width: 100%;
      box-sizing: border-box;
    }
    
    /* Specific mobile adjustments for word display */
    @media (max-width: 768px) {
      .word {
        font-size: clamp(1.2rem, 5vw, 1.8rem);
        letter-spacing: clamp(0.05em, 0.3vw, 0.2em);
        padding: 12px 8px;
      }
    }
    
    @media (max-width: 480px) {
      .word {
        font-size: clamp(1rem, 6vw, 1.4rem);
        letter-spacing: clamp(0.03em, 0.2vw, 0.15em);
        padding: 10px 6px;
      }
    }
    
    /* Ensure keyboard doesn't overflow on mobile */
    #keyboard {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 4px;
    }
    
    @media (max-width: 480px) {
      .kbd {
        min-width: 28px;
        padding: 4px 6px;
        margin: 2px;
        font-size: 0.9rem;
      }
    }
    
    .progress{ width:100%; background:#0b1220; border:1px solid #334155; border-radius:12px; overflow:hidden; height:12px }
    .bar{ height:100%; background:var(--accent); width:0%; transition:width .3s }
    table{ width:100%; border-collapse:collapse }
    th,td{ border-bottom:1px solid #243041; padding:10px; text-align:left }
    .hangman{ min-height:140px; display:flex; align-items:center; justify-content:center }
    .gallows{ font-family: "Courier New", monospace; white-space:pre; line-height:1.05 }
    .footnote{ font-size:12px; opacity:.85 }
    .tag{ font-size:12px; opacity:.9 }
    .center{ text-align:center }
    .loading { opacity: 0.6; pointer-events: none; }
    .error-msg { color: var(--bad); font-size: 12px; margin-top: 4px; }
    .success-msg { color: var(--good); font-size: 12px; margin-top: 4px; }
    .online-indicator { 
      display: inline-block; 
      width: 8px; 
      height: 8px; 
      background: var(--good); 
      border-radius: 50%; 
      margin-right: 6px;
      animation: pulse 2s infinite;
    }
    .offline-indicator {
      display: inline-block; 
      width: 8px; 
      height: 8px; 
      background: var(--bad); 
      border-radius: 50%; 
      margin-right: 6px;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .ranking-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .tab-btn {
      padding: 8px 16px;
      border: 1px solid #374151;
      background: var(--muted);
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    .tab-btn.active {
      background: var(--accent);
      color: #071126;
    }
    .tab-btn:hover {
      background: #374151;
    }
    .tab-btn.active:hover {
      background: var(--accent);
    }
    @media (max-width:700px){.grid-2{grid-template-columns:1fr}}
    
    /* Mobile responsiveness for scorebox */
    @media (max-width: 600px) {
      .scorebox {
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        gap: 6px !important;
      }
      .card {
        padding: 16px;
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 0 12px;
      }
      .row {
        gap: 8px;
      }
      .pill {
        font-size: 11px;
        padding: 4px 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Animated Banner -->
  <div class="banner">
    <div class="banner-content">
      <h1 class="banner-title">üåæ HARVEST TOWN üåæ</h1>
      <p class="banner-subtitle">Welcome to the Harvest Town Hangman Challenge!</p>
    </div>
    <div class="banner-icons">üöúüåΩüçÑ</div>
  </div>
  <div class="container">
    <!-- Login Screen -->
    <div class="card" id="screen-login">
      <h1>üîç Hangman: Harvest Town Edition‚Äì Player Login</h1>
      <p>Enter your IGN and Player ID to play. Words are curated by the Host.</p>
      <div id="connection-status" class="row" style="margin-bottom: 12px;">
        <span class="offline-indicator"></span>
        <span class="footnote">Connecting to online rankings...</span>
      </div>
      <h3>HOW TO PLAY: <h3>
        <h4><li>Guess one letter at a time. Correct guesses reveal letters.
        <li>Wrong guesses draw the hangman. You have limited lives.
        <li>Reveal the answer before you run out of lives. Goodluck!<h4>
      <div class="grid grid-2">
        <div>
          <label for="ign">IGN</label>
          <input id="ign" class="input" placeholder="e.g. GM HarYu" maxlength="50" />
        </div>
        <div>
          <label for="pid">Player ID</label>
          <input id="pid" class="input" placeholder="e.g. 13399604" maxlength="8" />
        </div>
      </div>
      <div class="row" style="margin-top:12px;justify-content:space-between;">
        <div class="footnote">After game ends (30 rounds), your score is added to both local and online rankings.</div>
        <button id="btnStart" class="btn btn-primary">Start Game</button>
      </div>
      <div class="center" style="margin-top:12px">
        <button id="toggleLeaderboardBtn" class="btn">View Rankings</button>
      </div>
      
      <!-- Rankings Section -->
      <div id="rankingsSection" class="hidden" style="margin-top: 16px;">
        <div class="ranking-tabs">
          <button class="tab-btn active" data-tab="local">üè† Local</button>
          <button class="tab-btn" data-tab="online">üåê Online</button>
        </div>
        
        <table id="leaderboardLocalTable" style="margin:12px auto;width:90%;max-width:700px">
          <thead><tr><th>#</th><th>IGN</th><th>Player ID</th><th>Score</th><th>Date</th></tr></thead>
          <tbody></tbody>
        </table>
        
        <table id="leaderboardOnlineTable" class="hidden" style="margin:12px auto;width:90%;max-width:700px">
          <thead><tr><th>#</th><th>IGN</th><th>Player ID</th><th>Score</th><th>Date</th></tr></thead>
          <tbody></tbody>
        </table>
        
        <div id="onlineRankingStatus" class="center footnote" style="margin-top: 8px;"></div>
      </div>
      
      <hr style="margin:18px 0;border-color:#1f2937" />
      <details>
        <summary>üõ†Ô∏è Settings(host only)</summary>
        <div style="margin-top:12px">
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            <label style="min-width:130px">Enter Host Passcode</label>
            <input id="hostPass" class="input" type="password" placeholder="passcode" style="max-width:280px" />
            <button id="btnCheckPassword" class="btn">Unlock Host Settings</button>
            <div id="hiddenContent" style="display: none;">
            <div class="footnote" style="margin-left:6px">Passcode: <code id="passnote">HTGMHARYU1324</code></div>
          </div>
          <div id="hostControls" class="hidden" style="margin-top:12px">
            <div class="grid grid-3">
              <div>
                <label>Lives per round</label>
                <input id="livesPerRound" type="number" class="input" min="3" max="10" value="6" />
              </div>
              <div>
                <label>Scoring (E / M / H base)</label>
                <div class="row">
                  <input id="scoreE" type="number" class="input" value="1" style="max-width:90px" />
                  <input id="scoreM" type="number" class="input" value="3" style="max-width:90px" />
                  <input id="scoreH" type="number" class="input" value="5" style="max-width:90px" />
                </div>
                <div class="footnote">Solved round awards base points + remaining lives as bonus.</div>
              </div>
              <div></div>
            </div>
            <div class="grid grid-3" style="margin-top:12px">
              <div>
                <label>Easy Words (one per line)</label>
                <textarea id="wordsE" rows="8" class="input"></textarea>
              </div>
              <div>
                <label>Medium Words (one per line)</label>
                <textarea id="wordsM" rows="8" class="input"></textarea>
              </div>
              <div>
                <label>Hard Words (one per line)</label>
                <textarea id="wordsH" rows="8" class="input"></textarea>
              </div>
            </div>
            <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
              <button id="btnApplyHost" class="btn btn-good">Apply Host Settings</button>
              <button id="btnLockHost" class="btn">Lock Host Settings</button>
              <button id="btnClearLeaderboard" class="btn" style="margin-left:6px">Clear Local Leaderboard</button>
              <button id="btnClearOnlineLeaderboard" class="btn btn-online" style="margin-left:6px">Clear Online Leaderboard</button>
            </div>
            <div class="footnote" style="margin-top:10px">Players cannot access or change these without the passcode. All words are stored locally in this browser.</div>
          </div>
        </div>
      </details>
    </div>

    <!-- Game Screen -->
    <div id="screen-game" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h2>üéØ Hangman: Harvest Town</h2>
          <div class="tag" id="playerTag">IGN ‚Äì Player ID</div>
        </div>
        <div class="scorebox" style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px">
          <div><div class="tag">Round</div><div id="roundInfo">1 / 30</div></div>
          <div><div class="tag">Phase</div><div id="phaseInfo">Easy 1/10</div></div>
          <div><div class="tag">Lives</div><div id="livesInfo">6</div></div>
          <div><div class="tag">Score</div><div id="scoreInfo">0</div></div>
        </div>
      </div>
      <div class="progress" style="margin:12px 0 8px"><div class="bar" id="progBar"></div></div>
      <div class="row" style="justify-content:space-between"><div class="pill" id="difficultyPill">Easy</div><div class="pill">Solve bonus = remaining lives</div></div>
      <div class="card" style="margin-top:16px;background:#1f2937;color:#ffffff">
        <div class="hangman"><pre class="gallows" id="gallows">  +---+
  |   |
      |
      |
      |
      |
=========</pre></div>
        <div class="word" id="wordDisplay">_ _ _ _</div>
        <div class="center" style="margin-top:10px" id="hintArea"></div>
        <div class="center footnote" id="statusMsg" style="min-height:22px">Pick a letter‚Ä¶</div>
        <div id="keyboard" class="center" style="margin-top:8px"></div>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <div class="pill" id="usedLetters">Used: </div>
        <div class="row"><span class="pill">Incorrect: <b id="misses">0</b></span><span class="pill">Correct: <b id="hits">0</b></span></div>
      </div>
    </div>

    <!-- Final Screen -->
    <div id="screen-finale" class="card hidden">
      <h2>üéÆ Game Over ‚Äì Final Score</h2>
      <p id="finalLine"></p>
      <div id="onlineSubmissionStatus" style="margin: 12px 0;"></div>
      <div class="grid grid-2">
        <div>
          <div class="card" style="background:#0b1220"><h3>Your Breakdown</h3><ul id="breakdown"></ul></div>
        </div>
        <div>
          <div class="card" style="background:#0b1220">
            <h3>üèÜ Rankings</h3>
            <div class="ranking-tabs">
              <button class="tab-btn active" data-tab="final-local">üè† Local</button>
              <button class="tab-btn" data-tab="final-online">üåê Online</button>
            </div>
            <table id="finalLocalTable">
              <thead><tr><th>#</th><th>IGN</th><th>Player ID</th><th>Score</th><th>Date</th></tr></thead>
              <tbody id="rankBody"></tbody>
            </table>
            <table id="finalOnlineTable" class="hidden">
              <thead><tr><th>#</th><th>IGN</th><th>Player ID</th><th>Score</th><th>Date</th></tr></thead>
              <tbody id="rankBodyOnline"></tbody>
            </table>
            <div class="footnote" style="color:var(--warn)">There is no restart/play-again button.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Storage and Configuration
    const STORAGE_KEYS = { host: 'hangman_host_config_v1', rank: 'hangman_rankings_v1' };
    
    // Online Rankings Configuration - Using localStorage with sync simulation
    const ONLINE_CONFIG = {
      storageKey: 'hangman_global_rankings_v2',
      enabled: true,
      syncInterval: 30000, // 30 seconds
      maxRankings: 50
    };
    
    const DEFAULT_WORDS = {      
      easy: `apple\nmanor\nhoe\ncow\nsheep\nchicken\npeacock\npig\nmilk\negg\nbarn\nonion\ngarlic\nwheat\neel\npeach\nblueberry\nrose\ntulips\nbarl\nabu\nstone\nfoxy\nfay\nmay\npotato\nbean\ntomato\nmango\npumpkin\nbanana\ngrape\ntofu`,
      medium: `sunflower\nnapa cabbage\nmallow root\nvegetable juice\norange juice\nshiitake sauce\ncurry sauce\ncopper ingot\nrefined quartz\nmiddle bait\npoultry feed\napple milkshake\nred piranha\nstone fish\nsturgeon\ngarra lamta\nstarfish\nskipjack tuna\ncherry pie\nsweet carp\nseaweed dish\nfried egg\ntangerine pudding\nlocket\nbrooch\nice cream\nfishing rod\nshovel\ndark essence`,
      hard: `ella cole\ntom cole\nandy reed\nbonfire party\nbeach party\nhair-caring ginseng powder\ncordyceps powdervginseng powder\ngastrodia powder\nbanana crisp\nchocolate bar\near-shaped cracker\nspicy fish head\nsauteed wax gourd\nyolk-baked corn\ngrass carp sashimi\nspider necklace\nshell crown\nmilk pudding\nblueberry pie\npumpkin cake\nhoneysuckle tea\ncooling tea\nqueen scale powder\nscale powder\nmary morris\nsteve lopez`
    };
    
    const DEFAULT_CONFIG = { 
      passcode: 'HTGMHARYU1324', 
      lives: 6, 
      scoreBase: { E: 1, M: 3, H: 5 }, 
      words: { 
        E: DEFAULT_WORDS.easy.split('\n'), 
        M: DEFAULT_WORDS.medium.split('\n'), 
        H: DEFAULT_WORDS.hard.split('\n') 
      } 
    };

    // Online Rankings System
    class OnlineRankings {
      constructor() {
        this.isOnline = false;
        this.rankings = [];
        this.lastFetch = null;
        this.checkConnection();
      }

      async checkConnection() {
        try {
          const response = await fetch(`${ONLINE_CONFIG.baseUrl}/${ONLINE_CONFIG.binId}/latest`, {
            method: 'GET',
            headers: ONLINE_CONFIG.headers
          });
          
          if (response.ok) {
            this.isOnline = true;
            this.updateConnectionStatus(true);
            await this.fetchRankings();
          } else {
            this.handleOffline();
          }
        } catch (error) {
          this.handleOffline();
        }
      }

      handleOffline() {
        this.isOnline = false;
        this.updateConnectionStatus(false);
        console.warn('Online rankings unavailable - using local only');
      }

      updateConnectionStatus(online) {
        const statusEl = document.getElementById('connection-status');
        const indicator = statusEl.querySelector('.offline-indicator, .online-indicator');
        const text = statusEl.querySelector('span:last-child');
        
        if (online) {
          indicator.className = 'online-indicator';
          text.textContent = 'Connected to online rankings';
        } else {
          indicator.className = 'offline-indicator';
          text.textContent = 'Offline mode - local rankings only';
        }
      }

      async fetchRankings() {
        if (!this.isOnline) return [];
        
        try {
          const response = await fetch(`${ONLINE_CONFIG.baseUrl}/${ONLINE_CONFIG.binId}/latest`, {
            method: 'GET',
            headers: ONLINE_CONFIG.headers
          });
          
          if (response.ok) {
            const data = await response.json();
            this.rankings = data.record.rankings || [];
            this.lastFetch = Date.now();
            return this.rankings;
          }
        } catch (error) {
          console.error('Failed to submit score:', error);
          return { success: false, error: error.message };
        }
      }

      getRankings() {
        return this.rankings;
      }
    }

    // Initialize online rankings
    const onlineRankings = new OnlineRankings();

    // Storage Functions
    function loadHostConfig() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.host);
        if (!raw) return structuredClone(DEFAULT_CONFIG);
        return JSON.parse(raw);
      } catch (e) {
        return structuredClone(DEFAULT_CONFIG);
      }
    }

    function saveHostConfig(cfg) { 
      localStorage.setItem(STORAGE_KEYS.host, JSON.stringify(cfg)); 
    }

    function getRanking() { 
      try { 
        return JSON.parse(localStorage.getItem(STORAGE_KEYS.rank) || '[]'); 
      } catch (e) { 
        return []; 
      } 
    }

    function saveRanking(list) { 
      localStorage.setItem(STORAGE_KEYS.rank, JSON.stringify(list)); 
    }

    // Initialize
    let hostCfg = loadHostConfig();
    
    // DOM Elements
    const elements = {
      ign: document.getElementById('ign'),
      pid: document.getElementById('pid'),
      btnStart: document.getElementById('btnStart'),
      hostPass: document.getElementById('hostPass'),
      btnCheckPassword: document.getElementById('btnCheckPassword'),
      hostControls: document.getElementById('hostControls'),
      passnote: document.getElementById('passnote'),
      livesPerRound: document.getElementById('livesPerRound'),
      scoreE: document.getElementById('scoreE'),
      scoreM: document.getElementById('scoreM'),
      scoreH: document.getElementById('scoreH'),
      wordsE: document.getElementById('wordsE'),
      wordsM: document.getElementById('wordsM'),
      wordsH: document.getElementById('wordsH'),
      btnApplyHost: document.getElementById('btnApplyHost'),
      btnLockHost: document.getElementById('btnLockHost'),
      btnClearLeaderboard: document.getElementById('btnClearLeaderboard'),
      screenLogin: document.getElementById('screen-login'),
      screenGame: document.getElementById('screen-game'),
      screenFinale: document.getElementById('screen-finale'),
      playerTag: document.getElementById('playerTag'),
      roundInfo: document.getElementById('roundInfo'),
      phaseInfo: document.getElementById('phaseInfo'),
      difficultyPill: document.getElementById('difficultyPill'),
      livesInfo: document.getElementById('livesInfo'),
      scoreInfo: document.getElementById('scoreInfo'),
      progBar: document.getElementById('progBar'),
      gallows: document.getElementById('gallows'),
      wordDisplay: document.getElementById('wordDisplay'),
      statusMsg: document.getElementById('statusMsg'),
      keyboardEl: document.getElementById('keyboard'),
      usedLetters: document.getElementById('usedLetters'),
      misses: document.getElementById('misses'),
      hits: document.getElementById('hits'),
      rankBody: document.getElementById('rankBody'),
      rankBodyOnline: document.getElementById('rankBodyOnline'),
      finalLine: document.getElementById('finalLine'),
      breakdown: document.getElementById('breakdown'),
      leaderboardLocalTable: document.querySelector('#leaderboardLocalTable tbody'),
      leaderboardOnlineTable: document.querySelector('#leaderboardOnlineTable tbody'),
      toggleLeaderboardBtn: document.getElementById('toggleLeaderboardBtn'),
      rankingsSection: document.getElementById('rankingsSection'),
      onlineRankingStatus: document.getElementById('onlineRankingStatus'),
      onlineSubmissionStatus: document.getElementById('onlineSubmissionStatus')
    };

    // Initialize display
    elements.passnote.textContent = hostCfg.passcode;
    elements.wordsE.value = hostCfg.words.E.join('\n');
    elements.wordsM.value = hostCfg.words.M.join('\n');
    elements.wordsH.value = hostCfg.words.H.join('\n');
    elements.livesPerRound.value = hostCfg.lives;
    elements.scoreE.value = hostCfg.scoreBase.E;
    elements.scoreM.value = hostCfg.scoreBase.M;
    elements.scoreH.value = hostCfg.scoreBase.H;

    // Game State
    const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    const state = { 
      ign: '', pid: '', totalRounds: 30, tier: 'E', tierIndex: 0, 
      round: 1, word: '', revealed: [], used: new Set(), lives: hostCfg.lives, 
      misses: 0, hits: 0, score: 0, breakdown: [], pools: { E: [], M: [], H: [] } 
    };

    // Game Functions
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function initPools() {
      state.pools.E = shuffle([...hostCfg.words.E]);
      state.pools.M = shuffle([...hostCfg.words.M]);
      state.pools.H = shuffle([...hostCfg.words.H]);
    }

    function nextTierAndIndex() {
      if (state.round <= 10) {
        state.tier = 'E';
        state.tierIndex = state.round - 1;
      } else if (state.round <= 20) {
        state.tier = 'M';
        state.tierIndex = state.round - 11;
      } else {
        state.tier = 'H';
        state.tierIndex = state.round - 21;
      }
    }

    function drawGallows(lives) {
      const stages = [
        `  +---+\n  |   |\n      |\n      |\n      |\n      |\n=========`,
        `  +---+\n  |   |\n  O   |\n      |\n      |\n      |\n=========`,
        `  +---+\n  |   |\n  O   |\n  |   |\n      |\n      |\n=========`,
        `  +---+\n  |   |\n  O   |\n /|   |\n      |\n      |\n=========`,
        `  +---+\n  |   |\n  O   |\n /|\\  |\n      |\n      |\n=========`,
        `  +---+\n  |   |\n  O   |\n /|\\  |\n /    |\n      |\n=========`,
        `  +---+\n  |   |\n  O   |\n /|\\  |\n / \\ |\n      |\n=========`
      ];
      const idx = Math.max(0, Math.min(stages.length - 1, hostCfg.lives - lives));
      elements.gallows.textContent = stages[idx];
    }

    function updateHUD() {
      elements.playerTag.textContent = `${state.ign} ‚Äì ${state.pid}`;
      elements.roundInfo.textContent = `${state.round} / ${state.totalRounds}`;
      const tierName = state.tier === 'E' ? 'Easy' : (state.tier === 'M' ? 'Medium' : 'Hard');
      elements.phaseInfo.textContent = `${tierName} ${state.tierIndex + 1}/10`;
      elements.difficultyPill.textContent = tierName;
      elements.livesInfo.textContent = state.lives;
      elements.scoreInfo.textContent = state.score;
      elements.misses.textContent = state.misses;
      elements.hits.textContent = state.hits;
      elements.progBar.style.width = `${((state.round - 1) / state.totalRounds) * 100}%`;
      elements.usedLetters.textContent = 'Used: ' + (Array.from(state.used).sort().join(' ') || '‚Äì');
      drawGallows(state.lives);
    }

    function pickWord() {
      const pool = state.pools[state.tier];
      if (!pool || pool.length === 0) {
        state.pools[state.tier] = shuffle([...hostCfg.words[state.tier]]);
      }
      return (state.pools[state.tier].pop() || 'word').toLowerCase();
    }

    function setWord(w) {
      state.word = w;
      state.revealed = w.split('').map(ch => {
        if (/^[a-z]$/i.test(ch)) return '_';
        return ch; // Keep spaces and other characters as-is
      });
      state.used = new Set();
      state.lives = hostCfg.lives;
      state.misses = 0;
      state.hits = 0;
      updateWordDisplay();
      elements.statusMsg.textContent = 'Pick a letter‚Ä¶';
      updateHUD();
      buildKeyboard();
    }

    function updateWordDisplay() {
      // Improved display logic for better mobile handling
      const words = state.word.split(' ');
      
      if (words.length === 1) {
        // Single word - use regular spacing
        let display = '';
        for (let i = 0; i < state.revealed.length; i++) {
          display += state.revealed[i];
          if (i < state.revealed.length - 1) {
            display += ' '; // Space between letters
          }
        }
        elements.wordDisplay.textContent = display;
      } else {
        // Multi-word - create line breaks for better mobile display
        let display = '';
        let currentPos = 0;
        
        for (let wordIndex = 0; wordIndex < words.length; wordIndex++) {
          const word = words[wordIndex];
          
          // Add letters for current word
          for (let letterIndex = 0; letterIndex < word.length; letterIndex++) {
            display += state.revealed[currentPos];
            if (letterIndex < word.length - 1) {
              display += ' '; // Space between letters in same word
            }
            currentPos++;
          }
          
          // Add word separator (line break for mobile, larger space for desktop)
          if (wordIndex < words.length - 1) {
            display += '\n'; // Line break between words
            currentPos++; // Skip the space character in the original word
          }
        }
        
        elements.wordDisplay.textContent = display;
      }
    }

    function buildKeyboard() {
      elements.keyboardEl.innerHTML = '';
      ALPHABET.forEach(letter => {
        const btn = document.createElement('button');
        btn.className = 'kbd';
        btn.textContent = letter;
        btn.disabled = state.used.has(letter);
        btn.onclick = () => guess(letter);
        elements.keyboardEl.appendChild(btn);
      });
    }

    function guess(letter) {
      state.used.add(letter);
      const btn = Array.from(elements.keyboardEl.children).find(b => b.textContent === letter);
      if (btn) btn.disabled = true;
      
      const indices = [];
      for (let i = 0; i < state.word.length; i++) {
        if (state.word[i].toUpperCase() === letter) indices.push(i);
      }
      
      if (indices.length) {
        indices.forEach(i => state.revealed[i] = state.word[i]);
        state.hits += 1;
        updateWordDisplay();
        updateHUD();
        // Check if word is complete (only counting letters, not spaces)
        const wordComplete = state.revealed.every((char, i) => 
          char === state.word[i] || !/^[a-z]$/i.test(state.word[i])
        );
        if (wordComplete) endRound(true);
      } else {
        state.misses += 1;
        state.lives -= 1;
        updateHUD();
        if (state.lives <= 0) endRound(false);
      }
    }

    function endRound(solved) {
      const base = hostCfg.scoreBase[state.tier];
      let gained = 0;
      if (solved) {
        gained = base + state.lives;
        state.score += gained;
        elements.statusMsg.textContent = `‚úì Correct! +${gained} points`;
      } else {
        elements.statusMsg.textContent = `‚úó The word was "${state.word}"`;
      }
      state.breakdown.push(`${state.round}. [${state.tier}] ${state.word} ‚Äì ${solved ? `Solved, +${gained}` : 'Failed'}`);
      
      setTimeout(() => {
        state.round++;
        if (state.round > state.totalRounds) return finishGame();
        nextTierAndIndex();
        setWord(pickWord());
      }, 1500);
    }

    function startGame() {
      state.round = 1;
      state.score = 0;
      state.breakdown = [];
      nextTierAndIndex();
      initPools();
      setWord(pickWord());
      elements.screenLogin.classList.add('hidden');
      elements.screenGame.classList.remove('hidden');
    }

    async function finishGame() {
      elements.screenGame.classList.add('hidden');
      elements.screenFinale.classList.remove('hidden');
      elements.finalLine.textContent = `${state.ign} ‚Äì ${state.pid} scored ${state.score} points.`;
      
      elements.breakdown.innerHTML = '';
      state.breakdown.forEach(line => {
        const li = document.createElement('li');
        li.textContent = line;
        elements.breakdown.appendChild(li);
      });
      
      // Save to local rankings
      const ranks = getRanking();
      ranks.push({ ign: state.ign, pid: state.pid, score: state.score, date: new Date().toLocaleString() });
      ranks.sort((a, b) => b.score - a.score);
      saveRanking(ranks.slice(0, 100));
      
      // Submit to online rankings
      await submitOnlineScore();
      
      renderFinalRankings();
    }

    async function submitOnlineScore() {
      const statusEl = elements.onlineSubmissionStatus;
      
      if (!onlineRankings.isOnline) {
        statusEl.innerHTML = '<span class="error-msg">‚ö†Ô∏è Score saved locally only - no internet connection</span>';
        return;
      }
      
      statusEl.innerHTML = '<span class="footnote">üì§ Submitting to online rankings...</span>';
      
      const result = await onlineRankings.submitScore({
        ign: state.ign,
        pid: state.pid,
        score: state.score
      });
      
      if (result.success) {
        statusEl.innerHTML = `<span class="success-msg">‚úÖ Score submitted! You ranked #${result.rank} globally!</span>`;
      } else {
        statusEl.innerHTML = `<span class="error-msg">‚å´ Failed to submit online: ${result.error}</span>`;
      }
    }

    function renderLocalRankings(tbody) {
      const ranks = getRanking();
      tbody.innerHTML = '';
      
      ranks.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx + 1}</td><td>${r.ign}</td><td>${r.pid}</td><td><b>${r.score}</b></td><td>${r.date}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function renderOnlineRankings(tbody, statusEl) {
      if (!onlineRankings.isOnline) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; opacity: 0.6;">Offline - online rankings unavailable</td></tr>';
        if (statusEl) statusEl.textContent = 'Connect to internet to view global rankings';
        return;
      }
      
      if (statusEl) statusEl.textContent = 'Loading online rankings...';
      
      try {
        const onlineRanks = await onlineRankings.fetchRankings();
        tbody.innerHTML = '';
        
        if (onlineRanks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; opacity: 0.6;">No online scores yet - be the first!</td></tr>';
          if (statusEl) statusEl.textContent = 'No global scores recorded yet';
          return;
        }
        
        onlineRanks.forEach((r, idx) => {
          const tr = document.createElement('tr');
          const date = new Date(r.date).toLocaleString();
          tr.innerHTML = `<td>${idx + 1}</td><td>${r.ign}</td><td>${r.pid}</td><td><b>${r.score}</b></td><td>${date}</td>`;
          tbody.appendChild(tr);
        });
        
        if (statusEl) statusEl.textContent = `${onlineRanks.length} global scores ‚Ä¢ Last updated: ${new Date().toLocaleString()}`;
      } catch (error) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; opacity: 0.6;">Failed to load online rankings</td></tr>';
        if (statusEl) statusEl.textContent = 'Failed to load global rankings';
      }
    }

    function renderFinalRankings() {
      renderLocalRankings(elements.rankBody);
      renderOnlineRankings(elements.rankBodyOnline);
    }

    // Tab Management
    function setupTabs() {
      document.addEventListener('click', (e) => {
        if (!e.target.matches('[data-tab]')) return;
        
        const tab = e.target.dataset.tab;
        const container = e.target.closest('#rankingsSection, #screen-finale');
        
        if (!container) return;
        
        // Update tab buttons
        container.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.tab === tab);
        });
        
        // Show/hide tables
        if (container.id === 'rankingsSection') {
          elements.leaderboardLocalTable.parentElement.classList.toggle('hidden', tab !== 'local');
          elements.leaderboardOnlineTable.parentElement.classList.toggle('hidden', tab !== 'online');
          
          if (tab === 'online') {
            renderOnlineRankings(elements.leaderboardOnlineTable, elements.onlineRankingStatus);
          }
        } else {
          document.getElementById('finalLocalTable').classList.toggle('hidden', tab !== 'final-local');
          document.getElementById('finalOnlineTable').classList.toggle('hidden', tab !== 'final-online');
          
          if (tab === 'final-online') {
            renderOnlineRankings(elements.rankBodyOnline);
          }
        }
      });
    }

    // Event Listeners
    elements.btnStart.onclick = () => {
      const ignV = elements.ign.value.trim();
      const pidV = elements.pid.value.trim();
      if (!ignV || !pidV) {
        alert('IGN & Player ID are required.');
        return;
      }
      state.ign = ignV;
      state.pid = pidV;
      startGame();
    };

    elements.btnCheckPassword.onclick = () => {
      if (elements.hostPass.value === hostCfg.passcode) {
        elements.hostControls.classList.remove('hidden');
        elements.hostPass.value = '';
      } else {
        alert('Incorrect passcode');
      }
    };

    elements.btnLockHost.onclick = () => {
      elements.hostControls.classList.add('hidden');
      elements.hostPass.value = '';
    };

    elements.btnApplyHost.onclick = () => {
      const clean = s => s.split('\n').map(w => w.trim().toLowerCase()).filter(Boolean);
      hostCfg.words = { 
        E: Array.from(new Set(clean(elements.wordsE.value))), 
        M: Array.from(new Set(clean(elements.wordsM.value))), 
        H: Array.from(new Set(clean(elements.wordsH.value))) 
      };
      hostCfg.lives = Math.max(3, Math.min(10, Number(elements.livesPerRound.value)));
      hostCfg.scoreBase = { 
        E: Number(elements.scoreE.value), 
        M: Number(elements.scoreM.value), 
        H: Number(elements.scoreH.value) 
      };
      saveHostConfig(hostCfg);
      alert('Host settings saved!');
      elements.hostControls.classList.add('hidden');
    };

    elements.btnClearLeaderboard.onclick = () => {
      if (confirm('Clear all local scores? (This will not affect online rankings)')) {
        localStorage.removeItem(STORAGE_KEYS.rank);
        renderLocalRankings(elements.leaderboardLocalTable);
        alert('Local leaderboard cleared!');
      }
    };

    elements.toggleLeaderboardBtn.onclick = () => {
      elements.rankingsSection.classList.toggle('hidden');
      if (!elements.rankingsSection.classList.contains('hidden')) {
        renderLocalRankings(elements.leaderboardLocalTable);
        // Don't auto-load online rankings to save API calls
      }
    };

    elements.btnClearOnlineLeaderboard = document.getElementById('btnClearOnlineLeaderboard');
     elements.btnClearOnlineLeaderboard.onclick = async () => {
      if (!onlineRankings.isOnline) {
        alert('Cannot clear online leaderboard ‚Äì not connected.');
        return;
      }
      if (!confirm('‚ö†Ô∏è This will clear all global rankings. Continue?')) return;
      
      try {
        onlineRankings.clearAllRankings();
        alert('‚úÖ Global leaderboard cleared!');
        
        // Refresh displays
        renderOnlineRankings(elements.leaderboardOnlineTable, elements.onlineRankingStatus);
        if (elements.rankBodyOnline) {
          renderOnlineRankings(elements.rankBodyOnline);
        }
      } catch (err) {
        console.error(err);
        alert('‚å´ Error clearing online leaderboard: ' + err.message);
      }
    };

    // Keyboard support
    document.addEventListener('keydown', (e) => {
      if (!/^[a-z]$/i.test(e.key) || elements.screenGame.classList.contains('hidden')) return;
      const letter = e.key.toUpperCase();
      const btn = Array.from(elements.keyboardEl.children).find(b => b.textContent === letter);
      if (btn && !btn.disabled) btn.click();
    });

    // Initialize
    setupTabs();
    renderLocalRankings(elements.leaderboardLocalTable);
  </script>
</body>
</html>

          
